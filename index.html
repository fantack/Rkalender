<!DOCTYPE html>
<html lang="et" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>R Kalender</title>

    <!-- Favicon / Tab icon -->
    <link rel="icon" type="image/jpeg" href="https://i.pinimg.com/736x/f2/fb/f9/f2fbf9b2b87779184468e89cc82bfeb4.jpg">
    <link rel="shortcut icon" type="image/jpeg" href="https://i.pinimg.com/736x/f2/fb/f9/f2fbf9b2b87779184468e89cc82bfeb4.jpg">
    <link rel="apple-touch-icon" href="https://i.pinimg.com/736x/f2/fb/f9/f2fbf9b2b87779184468e89cc82bfeb4.jpg">
    <meta name="color-scheme" content="light dark">

    <!-- Tailwind CSS (dark mode via class) -->
    <script>
      tailwind.config = { darkMode: 'class' };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tone.js for custom sound -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <!-- Web App Manifest (for "Add to Home Screen") -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlIgS2FsZW5kZXIiLAogICJzaG9ydF9uYW1lIjogIlJLYWxlbmRlciIsCiAgImRlc2NyaXB0aW9uIjogIkhlcHBmbiB3ZWVrbHkgcGxhbm5lciIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImh0dHBzOi8vaS5waW5pbWcuY29tLzczNngvZjIvZmIvZjkvZjJmYmY5YjJiODc3NzkxODQ0NjhlODljYzgyYmZlYjQuanBnIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9qcGVnIgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL2kucGluaW1nLmNvbS83MzZ4L2YyL2ZiL2Y5L2YyZmJmOWIyYjg3Nzc5MTg0NDY4ZTg5Y2M4MmJmZWI0LmpwZyIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvanBlZyIKICAgIH0KICBdLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgInRoZW1lX2NvbG9yIjogIiMxZjI5MzciLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwZTE3MjUiCn0=">

    <style>
        /* Custom styles for better look and feel */
        body {
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }
        .calendar-grid {
            grid-template-columns: 2.5rem repeat(7, 1fr);
        }
        .emoji-picker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 0.5rem;
        }

        /* FIX: kasutame ID selektoreid (#color-picker ja #emoji-picker), mitte klasse */
        #color-picker span {
            transition: transform 0.2s ease;
        }
        #color-picker span.selected {
            transform: scale(1.2);
            outline: 3px solid #3b82f6; /* blue-500 */
            outline-offset: 2px;
        }
        html.dark #color-picker span.selected {
             outline-color: #60a5fa; /* blue-400 */
        }
        #emoji-picker button {
            transition: transform 0.2s ease, outline 0.2s ease;
        }
        #emoji-picker button.selected {
            outline: 3px solid #3b82f6; /* blue-500 */
            outline-offset: 2px;
            border-radius: 8px;
            transform: scale(1.1);
        }
        html.dark #emoji-picker button.selected {
            outline-color: #60a5fa; /* blue-400 */
        }

        .day-header.today {
            background-color: #fbbf24; /* Amber 400 */
            color: #1f2937;
        }
        html.dark .day-header.today {
            background-color: #f59e0b; /* Amber 500 */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
            border-radius: 10px;
        }
         html.dark ::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* slate-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* slate-400 */
        }
    </style>
</head>
<body class="bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200 min-h-screen overflow-x-hidden font-sans transition-colors duration-300">

    <div id="app-container" class="max-w-4xl mx-auto p-2 sm:p-4">
        <!-- Header -->
        <header class="flex justify-between items-center mb-4">
            <h1 class="text-2xl sm:text-3xl font-bold text-slate-900 dark:text-white">R Kalender</h1>
            <div class="flex items-center space-x-2">
                <span class="text-sm">Hele</span>
                <button id="theme-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-slate-300 dark:bg-slate-600 focus:outline-none">
                    <span id="theme-toggle-indicator" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform translate-x-1 dark:translate-x-6"></span>
                </button>
                <span class="text-sm">Tume</span>
            </div>
        </header>

        <!-- Calendar -->
        <div id="calendar" class="overflow-x-auto">
            <div class="calendar-grid grid gap-1">
                <!-- Headers will be generated by JS -->
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-4 text-center flex justify-center items-center space-x-4">
            <button id="delete-row-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-transform transform hover:scale-105 hidden">
                - Kustuta Rida
            </button>
            <button id="add-row-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-transform transform hover:scale-105">
                + Lisa Rida
            </button>
        </div>
    </div>

    <!-- Modal for adding/editing events -->
    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-2xl w-full max-w-sm p-6 transform transition-all scale-95 opacity-0" id="modal-content">
            <h2 class="text-xl font-bold mb-4" id="modal-title">Lisa Sündmus</h2>
            
            <div class="space-y-4">
                <!-- Event Text -->
                <div>
                    <label for="event-text" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Tegevus</label>
                    <input type="text" id="event-text" placeholder="Nt: Jõusaal" class="mt-1 block w-full bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <!-- Time -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="event-start-time" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Algus</label>
                        <input type="time" id="event-start-time" step="300" class="mt-1 block w-full bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="event-end-time" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Lõpp</label>
                        <input type="time" id="event-end-time" step="300" class="mt-1 block w-full bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <!-- Notification Time -->
                 <div>
                    <label for="notification-time" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Teavituse aeg</label>
                    <input type="time" id="notification-time" step="300" class="mt-1 block w-full bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>

                <!-- Color Picker -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Värv</label>
                    <div id="color-picker" class="mt-2 flex justify-around p-2 bg-slate-100 dark:bg-slate-700 rounded-lg">
                        <!-- Colors will be generated by JS -->
                    </div>
                </div>

                <!-- Emoji Picker -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Ikoon</label>
                    <div id="emoji-picker" class="mt-2 p-2 bg-slate-100 dark:bg-slate-700 rounded-lg max-h-32 overflow-y-auto emoji-picker-grid">
                        <!-- Emojis will be generated by JS -->
                    </div>
                </div>
            </div>

            <!-- Modal Actions -->
            <div class="mt-6 flex justify-between">
                <button id="delete-event-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md shadow-sm transition-colors hidden">Kustuta</button>
                <div class="flex-grow flex justify-end space-x-3">
                     <button id="cancel-event-btn" class="bg-slate-300 hover:bg-slate-400 dark:bg-slate-600 dark:hover:bg-slate-500 text-slate-800 dark:text-slate-200 font-bold py-2 px-4 rounded-md shadow-sm transition-colors">Tühista</button>
                    <button id="save-event-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-sm transition-colors">Salvesta</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            const COLORS = {
                red: 'bg-red-500',
                yellow: 'bg-yellow-400',
                blue: 'bg-blue-500',
                green: 'bg-green-500',
                purple: 'bg-purple-500',
                brown: 'bg-amber-800',
                pink: 'bg-pink-400',
                orange: 'bg-orange-500',
            };
            const EMOJIS = ['💧', '🥳', '🍷', '🍦', '🍔', '✈️', '🏠', '🏋️', '🍆', '🏙️', '⚽️', '🪁', '⚓', '✝️', '📖', '🏢', '🏫', '🏃', '🚗', '🛒', '💼', '🎣', '🍼', '💻', '📱', '☕'];
            const WEEKDAYS = ['P', 'E', 'T', 'K', 'N', 'R', 'L'];
            const INITIAL_ROWS = 5;

            // --- STATE MANAGEMENT ---
            let state = {
                theme: 'dark',
                events: {},
                rows: INITIAL_ROWS,
            };

            // --- DOM ELEMENTS ---
            const themeToggle = document.getElementById('theme-toggle');
            const themeToggleIndicator = document.getElementById('theme-toggle-indicator');
            const calendarGrid = document.querySelector('.calendar-grid');
            const addRowBtn = document.getElementById('add-row-btn');
            const deleteRowBtn = document.getElementById('delete-row-btn');
            const modal = document.getElementById('event-modal');
            const modalContent = document.getElementById('modal-content');
            const saveBtn = document.getElementById('save-event-btn');
            const cancelBtn = document.getElementById('cancel-event-btn');
            const deleteBtn = document.getElementById('delete-event-btn');
            const colorPicker = document.getElementById('color-picker');
            const emojiPicker = document.getElementById('emoji-picker');
            const eventText = document.getElementById('event-text');
            const eventStartTime = document.getElementById('event-start-time');
            const eventEndTime = document.getElementById('event-end-time');
            const notificationTime = document.getElementById('notification-time');

            let currentEditingSlot = null;
            let scheduledNotifications = {};

            // --- INITIALIZATION ---
            function init() {
                loadState();
                setupTheme();
                setupPickers();
                renderCalendar();
                setupEventListeners();
                
                if (window.matchMedia('(display-mode: standalone)').matches) {
                    if (!localStorage.getItem('notificationPermissionRequested')) {
                        requestNotificationPermission();
                        localStorage.setItem('notificationPermissionRequested', 'true');
                    }
                }
            }
            
            // --- THEME ---
            function setupTheme() {
                document.documentElement.classList.toggle('dark', state.theme === 'dark');
            }

            function toggleTheme() {
                state.theme = state.theme === 'dark' ? 'light' : 'dark';
                document.documentElement.classList.toggle('dark', state.theme === 'dark');
                saveState();
            }

            // --- PERSISTENCE (LocalStorage) ---
            function saveState() {
                localStorage.setItem('rCalendarState', JSON.stringify(state));
            }

            function loadState() {
                const savedState = localStorage.getItem('rCalendarState');
                if (savedState) {
                    const loadedState = JSON.parse(savedState);
                    loadedState.rows = Math.max(INITIAL_ROWS, loadedState.rows || INITIAL_ROWS);
                    state = loadedState;
                }
            }

            // --- CALENDAR RENDERING ---
            function renderCalendar() {
                calendarGrid.innerHTML = '';
                const today = new Date();
                const todayIndex = today.getDay(); // Sunday - 0, Monday - 1...

                calendarGrid.appendChild(document.createElement('div'));

                for (let i = 0; i < 7; i++) {
                    const dayIndex = (todayIndex + i) % 7;
                    const dayDate = new Date();
                    dayDate.setDate(today.getDate() + i);
                    
                    const header = document.createElement('div');
                    header.className = 'day-header text-center font-bold p-1 rounded-md text-xs sm:text-base';
                    header.innerHTML = `${WEEKDAYS[dayIndex]}<br>${dayDate.getDate()}`;
                    if (i === 0) {
                        header.classList.add('today');
                    }
                    calendarGrid.appendChild(header);
                }
                
                for (let r = 0; r < state.rows; r++) {
                    const timeLabel = document.createElement('div');
                    timeLabel.className = 'text-center text-xs text-slate-500 dark:text-slate-400 self-center';
                    calendarGrid.appendChild(timeLabel);

                    for (let d = 0; d < 7; d++) {
                        const slotId = `${d}-${r}`;
                        const slot = document.createElement('div');
                        slot.className = 'calendar-slot h-20 bg-slate-50 dark:bg-slate-800 rounded-lg shadow-sm cursor-pointer flex flex-col items-center justify-center text-center p-1 overflow-hidden hover:ring-2 ring-blue-500 transition-all';
                        slot.dataset.slotId = slotId;
                        
                        const event = state.events[slotId];
                        if (event) {
                           const isLightColor = ['yellow', 'pink'].includes(event.color);
                           const textColorClass = isLightColor ? 'text-black' : 'text-white';
                           const timeColorClass = isLightColor ? 'text-gray-600' : 'text-slate-200';

                           slot.innerHTML = `
                                <div class="text-3xl">${event.emoji || ''}</div>
                                <div class="text-xs font-semibold leading-tight">${event.text || ''}</div>
                                <div class="text-xxs mt-1 ${timeColorClass}">${event.startTime || ''} - ${event.endTime || ''}</div>
                            `;
                            slot.classList.remove('bg-slate-50', 'dark:bg-slate-800');
                            slot.classList.add(COLORS[event.color] || 'bg-slate-200');
                            slot.classList.add(textColorClass);
                        }
                        
                        calendarGrid.appendChild(slot);
                    }
                }
                deleteRowBtn.classList.toggle('hidden', state.rows <= INITIAL_ROWS);
            }

            function addRow() {
                state.rows++;
                renderCalendar();
                saveState();
            }

            function deleteRow() {
                if (state.rows > INITIAL_ROWS) {
                    state.rows--;
                    for (let d = 0; d < 7; d++) {
                        const slotId = `${d}-${state.rows}`;
                        if (state.events[slotId]) {
                            delete state.events[slotId];
                        }
                    }
                    renderCalendar();
                    saveState();
                }
            }


            // --- MODAL & EVENT HANDLING ---
            function openModal(slotId) {
                currentEditingSlot = slotId;
                const event = state.events[slotId];
                
                eventText.value = '';
                eventStartTime.value = '';
                eventEndTime.value = '';
                notificationTime.value = '';
                document.querySelectorAll('#color-picker .selected, #emoji-picker .selected').forEach(el => el.classList.remove('selected'));

                if (event) {
                    document.getElementById('modal-title').textContent = 'Muuda Sündmust';
                    eventText.value = event.text || '';
                    eventStartTime.value = event.startTime || '';
                    eventEndTime.value = event.endTime || '';
                    notificationTime.value = event.notificationTime || '';
                    if (event.color) {
                        const colorEl = document.querySelector(`#color-picker [data-color="${event.color}"]`);
                        if (colorEl) colorEl.classList.add('selected');
                    }
                    if (event.emoji) {
                        const emojiEl = document.querySelector(`#emoji-picker [data-emoji="${event.emoji}"]`);
                        if (emojiEl) emojiEl.classList.add('selected');
                    }
                    deleteBtn.classList.remove('hidden');
                } else {
                    document.getElementById('modal-title').textContent = 'Lisa Sündmus';
                    deleteBtn.classList.add('hidden');
                }

                modal.classList.remove('hidden');
                setTimeout(() => {
                    modalContent.classList.remove('scale-95', 'opacity-0');
                }, 10);
            }

            function closeModal() {
                modalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 200);
            }

            function saveEvent() {
                const selectedColorEl = document.querySelector('#color-picker .selected');
                const selectedEmojiEl = document.querySelector('#emoji-picker .selected');

                const eventData = {
                    text: eventText.value,
                    startTime: eventStartTime.value,
                    endTime: eventEndTime.value,
                    notificationTime: notificationTime.value,
                    color: selectedColorEl ? selectedColorEl.dataset.color : 'blue',
                    emoji: selectedEmojiEl ? selectedEmojiEl.dataset.emoji : '',
                };

                state.events[currentEditingSlot] = eventData;
                
                if (eventData.notificationTime) {
                    scheduleNotification(eventData, currentEditingSlot);
                } else {
                    cancelNotification(currentEditingSlot);
                }

                saveState();
                renderCalendar();
                closeModal();
            }

            function deleteEvent() {
                delete state.events[currentEditingSlot];
                cancelNotification(currentEditingSlot);
                saveState();
                renderCalendar();
                closeModal();
            }

            // --- PICKERS (Color & Emoji) ---
            function setupPickers() {
                Object.entries(COLORS).forEach(([name, className]) => {
                    const span = document.createElement('span');
                    span.className = `inline-block w-8 h-8 rounded-full cursor-pointer ${className} shadow-inner`;
                    span.dataset.color = name;
                    colorPicker.appendChild(span);
                });

                EMOJIS.forEach(emoji => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'text-2xl rounded-lg p-1 hover:bg-slate-200 dark:hover:bg-slate-600';
                    button.textContent = emoji;
                    button.dataset.emoji = emoji;
                    emojiPicker.appendChild(button);
                });
            }

            function handlePickerSelection(e, containerId) {
                const container = document.getElementById(containerId);
                const target = e.target.closest('[data-color], [data-emoji]');
                if (!target) return;
                
                const currentSelected = container.querySelector('.selected');
                if (currentSelected) {
                    currentSelected.classList.remove('selected');
                }
                if (currentSelected !== target) {
                    target.classList.add('selected');
                }
            }
            
            // --- NOTIFICATIONS ---
            function requestNotificationPermission() {
                if ('Notification' in window) {
                    Notification.requestPermission().then(permission => {
                        if (permission !== 'granted') console.log('Notification permission denied.');
                    });
                }
            }

            function scheduleNotification(event, slotId) {
                cancelNotification(slotId); 
                if (Notification.permission !== 'granted' || !event.notificationTime) return;
                
                const [hours, minutes] = event.notificationTime.split(':').map(Number);
                const now = new Date();
                const dayOffset = parseInt(slotId.split('-')[0], 10);

                let notificationDate = new Date();
                notificationDate.setDate(now.getDate() + dayOffset);
                notificationDate.setHours(hours, minutes, 0, 0);

                if (notificationDate < now) {
                    notificationDate.setDate(notificationDate.getDate() + 7);
                }

                const delay = notificationDate.getTime() - now.getTime();
                
                if (delay > 0) {
                    const timeoutId = setTimeout(() => {
                        showNotification(event.text);
                        scheduleNotification(event, slotId);
                    }, delay);
                    scheduledNotifications[slotId] = timeoutId;
                }
            }

            function showNotification(text) {
                new Notification('R Kalender Meeldetuletus', {
                    body: text,
                    icon: 'https://i.pinimg.com/736x/f2/fb/f9/f2fbf9b2b87779184468e89cc82bfeb4.jpg',
                });
                playNotificationSound();
            }
            
            function cancelNotification(slotId) {
                if (scheduledNotifications[slotId]) {
                    clearTimeout(scheduledNotifications[slotId]);
                    delete scheduledNotifications[slotId];
                }
            }
            
            function playNotificationSound() {
                if (Tone.context.state !== 'running') {
                    Tone.start();
                }
                const synth = new Tone.Synth().toDestination();
                synth.triggerAttackRelease("C5", "8n");
            }
            
            // --- EVENT LISTENERS ---
            function setupEventListeners() {
                themeToggle.addEventListener('click', toggleTheme);
                addRowBtn.addEventListener('click', addRow);
                deleteRowBtn.addEventListener('click', deleteRow);
                calendarGrid.addEventListener('click', (e) => {
                    const slot = e.target.closest('.calendar-slot');
                    if (slot) openModal(slot.dataset.slotId);
                });
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal();
                });
                saveBtn.addEventListener('click', saveEvent);
                cancelBtn.addEventListener('click', closeModal);
                deleteBtn.addEventListener('click', deleteEvent);
                colorPicker.addEventListener('click', (e) => handlePickerSelection(e, 'color-picker'));
                emojiPicker.addEventListener('click', (e) => handlePickerSelection(e, 'emoji-picker'));
            }

            init();
        });
    </script>

</body>
</html>


